/*============================================================================
** 作者：侯玉鹏
** 日期：2017/10/31
** 版本：V1.0
** 函数名: 
** 函数功能：
** 输入参数：
** 输出 ：1  返回值：
          2  改变的全局变量
** 本函数调用的其它函数（版本号）：
** 备注：
** 修改日志： （作者，日期，修改内容及原因）
==============================================================================*/


/*============================ INCLUDES ======================================*/

#include "stm32f10x.h"
#include "systream_time.h"
#include "FlyControl_init.h"
#include "scheduler.h"
/*============================ MACROS ========================================*/

/* 设置获取时间的数组数量 */
#define GET_TIME_NUM 	    (3)

/* 换算成SYStick定时器计数微秒单位的比例 */
#define TICK_US	(1000000/TICK_PER_SECOND)

/*============================ TYPES =========================================*/

/*============================ GLOBAL VARIABLES ==============================*/

extern u8 Init_Finish;
extern u32 TIME_ISR_CNT;
/*============================ STATIC VARIABLES ==============================*/

/* 复位起的总中断次数 */
volatile uint32_t sysTickUptime = 0;

/* 计算两次点用时间间隔的数组 */
volatile float Cycle_T[GET_TIME_NUM][3];

/* 数组下标枚举体 */
enum
{
    NOW = 0,
    OLD,
    NEW,
};
/*============================ FUNCTION ======================================*/

/*----------------------------------------------------------
 + 实现功能：获取系统总运行时间
 + 返回参数：微秒
----------------------------------------------------------*/
uint32_t GetSysTime_us(void)
{	
    /* 系统总运行 单位：毫秒 */
    register uint32_t ms;
    /* 用于返回的变量 单位：微秒 */
    u32 value;
    /* 获取系统总运行 单位：毫秒 */
    ms = sysTickUptime;
    /* 计算并获取为系统总运行 单位：微秒 */
    value = ms * TICK_US + (SysTick->LOAD - SysTick->VAL) * TICK_US / SysTick->LOAD;
    /* 返回参数 单位：微秒 */
    return value;
}

/*----------------------------------------------------------
 + 实现功能：延时
 + 调用参数：微秒
----------------------------------------------------------*/
void Delay_us(uint32_t us)
{
    /* 获取系统时钟 单位微秒 */
    uint32_t now = GetSysTime_us();
    /* 比较两次时间差 */
    while (GetSysTime_us() - now < us);
}

/*----------------------------------------------------------
 + 实现功能：延时
 + 调用参数：毫秒
----------------------------------------------------------*/
void Delay_ms(uint32_t ms)
{
    /* 延时微秒次数 */
    while (ms--) Delay_us(1000);
}

/*----------------------------------------------------------
 + 实现功能：计算两次点用时间间隔
 + 调用参数：统计时间项数组
 + 返回参数：两次时间间隔 单位：秒
----------------------------------------------------------*/
float Call_timer_cycle(u8 item)
{
    /* 上一次的时间 */
    Cycle_T[item][OLD] = Cycle_T[item][NOW];
    /* 本次的时间 */
    Cycle_T[item][NOW] = GetSysTime_us()/1000000.0f;
    /* 间隔的时间 单位：秒 */
    Cycle_T[item][NEW] = ( ( Cycle_T[item][NOW] - Cycle_T[item][OLD] ) );
    /* 两次时间间隔 单位：秒 */
    return Cycle_T[item][NEW];
}

/*----------------------------------------------------------
 + 实现功能：时间统计初始化
----------------------------------------------------------*/
void Cycle_Time_Init()
{
    /* 计算两次点用时间间隔数组清零 */
    for(u8 i=0; i<GET_TIME_NUM; i++)
        Call_timer_cycle(i);
}

/*----------------------------------------------------------
 + 实现功能：由SysTick定时中断调用，周期1ms
----------------------------------------------------------*/
void SysTick_Handler(void)
{
    /* 复位起的总中断次数 */
    sysTickUptime++;
    /* 系统没有初始化好，不进行大循环 */
    if( ! Init_Finish) return;
    /* 大循环统计 */
    Call_Loop_timer();
}


